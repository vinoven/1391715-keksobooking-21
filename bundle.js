(()=>{"use strict";window.fileChooser={process:(e,t,o)=>{const r=e.files[0],n=r.name.toLowerCase();if(t.some((e=>n.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{o(e.result)})),e.readAsDataURL(r)}}},(()=>{const e=(e,t,o,r)=>{const n=new XMLHttpRequest;return n.responseType="json",n.timeout=1e4,n.open(e,t),n.addEventListener("load",(()=>{switch(n.status){case 200:o(n.response);break;case 400:r("Неверный запрос");break;case 401:r("Ошибка авторизации");break;case 404:r("Ничего не найдено");break;default:r("Cтатус ответа: "+n.status+" "+n.statusText)}})),n.addEventListener("error",(()=>{r("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{r("Запрос не успел выполниться за "+n.timeout+" мс")})),n};window.request={load:(t,o)=>{e("GET","https://21.javascript.pages.academy/keksobooking/data",t,o).send()},upload:(t,o,r)=>{e("POST","https://21.javascript.pages.academy/keksobooking",o,r).send(t)}}})(),window.debounce=e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}},(()=>{const e="any",t=document.querySelector(".map__filters"),o=t.children,r=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),s=t.querySelector("#housing-rooms"),a=t.querySelector("#housing-guests"),i=t.querySelector("#housing-features"),d=window.debounce((()=>{const t=window.data.get().filter((t=>(e=>{const t=e.offer.price;switch(n.value){case"any":return!0;case"low":return t<1e4;case"middle":return t>=1e4&&t<=5e4;case"high":return t>5e4;default:return!1}})(t)&&(t=>r.value===t.offer.type||r.value===e)(t)&&(t=>Number(s.value)===t.offer.rooms||s.value===e)(t)&&(t=>Number(a.value)===t.offer.guests||a.value===e)(t)&&(e=>{const t=(e=>{let t=[];return e.forEach((e=>{e.checked&&t.push(e.value)})),t})(i.querySelectorAll(".map__checkbox")),o=e.offer.features;return t.every((e=>o.includes(e)))})(t)));window.card.remove(),window.pins.remove(),window.pins.render(t)}));t.addEventListener("change",(()=>{d()})),window.filter={activate:()=>{window.util.toggleElementsState(o,!1)},deactivate:()=>{t.reset(),window.util.toggleElementsState(o,!0)}}})(),(()=>{const e=e=>{27!==e.keyCode&&0!==e.button||(document.querySelector(".success").remove(),document.removeEventListener("click",t),document.removeEventListener("keydown",o))},t=t=>{e(t)},o=t=>{e(t)},r=e=>{a(e)},n=e=>{a(e)},s=e=>{a(e)},a=e=>{27!==e.keyCode&&0!==e.button||(document.querySelector(".error").remove(),document.removeEventListener("click",r),document.removeEventListener("keydown",n))};window.message={success:()=>{const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.querySelector("main").appendChild(e),document.addEventListener("click",t),document.addEventListener("keydown",o)},error:e=>{const t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);t.querySelector(".error__message").textContent=e,document.body.appendChild(t),document.querySelector(".error__button").addEventListener("click",s),document.addEventListener("click",r),document.addEventListener("keydown",n)}}})(),window.util={removeElements:e=>{for(;e.length>0;)e[0].remove()},toggleElementsState:(e,t)=>{for(let o=0;o<e.length;o++)e[o].disabled=t}},(()=>{const e={palace:1e4,flat:1e3,house:5e3,bungalow:0},t=["gif","jpg","jpeg","png"],o=document.querySelector(".ad-form"),r=o.querySelector("#address"),n=o.querySelector(".ad-form__reset"),s=o.querySelector("#capacity"),a=o.querySelector("#room_number"),i=o.querySelector("#type"),d=o.querySelector("#price"),c=o.querySelector("#timein"),l=o.querySelector("#timeout"),u=o.querySelector("#images"),m=o.querySelector(".ad-form__photo"),p=o.querySelector("#avatar"),v=o.querySelector(".ad-form-header__preview img"),w=v.src,f=()=>{const t=i.value;d.min=e[t],d.placeholder=e[t]},y=()=>{window.pins.remove(),window.card.remove(),window.mainPin.resetPosition(),f(),o.reset(),h(),S(),window.main.deactivatePage()},g=e=>{window.message.success(e),y()},h=()=>{m.innerHTML=""},S=()=>{v.src=w},_=e=>{h(),m.appendChild((e=>{const t=document.createElement("img");return t.src=e,t.style.maxWidth="100%",t})(e))},L=e=>{v.src=e},q=e=>{(e=>{const t=new FormData(o);window.request.upload(t,g,window.message.error),e.preventDefault()})(e)},E=()=>{"100"!==a.value&&s.value>a.value?s.setCustomValidity("Гостей не должно быть больше количества комнат"):"100"===a.value&&"0"!==s.value?s.setCustomValidity("100 комнат недоступны для гостей"):"100"!==a.value&&"0"===s.value?s.setCustomValidity("Укажите количество гостей"):s.setCustomValidity(""),s.reportValidity()},k=()=>{f()},C=()=>{l.value=c.value},b=()=>{c.value=l.value},x=()=>{y()},P=()=>{window.fileChooser.process(u,t,_)},V=()=>{window.fileChooser.process(p,t,L)};window.form={fillAddressField:()=>{r.value=window.mainPin.getPointerPosition()},addListeners:()=>{o.addEventListener("submit",q),s.addEventListener("change",E),i.addEventListener("change",k),c.addEventListener("change",C),l.addEventListener("change",b),n.addEventListener("click",x),u.addEventListener("change",P),p.addEventListener("change",V)},removeListeners:()=>{o.removeEventListener("submit",q),s.removeEventListener("change",E),i.removeEventListener("change",k),c.removeEventListener("change",C),l.removeEventListener("change",b),n.removeEventListener("click",x),u.removeEventListener("change",P),p.removeEventListener("change",V)}}})(),(()=>{let e=null;window.data={get:()=>e,save:t=>{e=t}}})(),(()=>{const e="375px",t="570px",o=document.querySelector(".map__pins"),r=document.querySelector(".map"),n=o.querySelector(".map__pin--main"),s=e=>{0===e.button&&window.main.activatePage()},a=e=>{13===e.keyCode&&window.main.activatePage()};n.addEventListener("mousedown",(e=>{let t={x:e.clientX,y:e.clientY};const r=e=>{let r=t.x-e.clientX,s=t.y-e.clientY;const a=n.offsetLeft-r,i=n.offsetTop-s;t={x:e.clientX,y:e.clientY},(()=>{const e=window.getComputedStyle(n).getPropertyValue("width").slice(0,-2)/2,t=0-e,r=window.getComputedStyle(o).getPropertyValue("width").slice(0,-2)-e,s=window.getComputedStyle(n).getPropertyValue("height").slice(0,-2),d=Number(s)+Number(22),c=130-d,l=630-d;n.style.left=a<t?t+"px":a>r?r+"px":a+"px",n.style.top=i<c?c+"px":i>l?l+"px":i+"px"})(),window.form.fillAddressField()},s=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",s)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",s)})),window.mainPin={getPointerPosition:()=>{const e=parseInt(getComputedStyle(n).getPropertyValue("width"),10),t=parseInt(getComputedStyle(n).getPropertyValue("height"),10),o=parseInt(getComputedStyle(n).getPropertyValue("left"),10),s=parseInt(getComputedStyle(n).getPropertyValue("top"),10);return[Math.round(o+e/2),Math.round(r.classList.contains("map--faded")?s+t/2:s+t+22)]},resetPosition:()=>{n.style.left=t,n.style.top=e},addListeners:()=>{n.addEventListener("mousedown",s),n.addEventListener("keydown",a)},removeListeners:()=>{n.removeEventListener("mousedown",s),n.removeEventListener("keydown",a)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=document.querySelector(".map__pins"),o=(t,o)=>{const r=e.cloneNode(!0);return r.style.left=t.location.x-25+"px",r.style.top=t.location.y-70+"px",r.querySelector("img").src=t.author.avatar,r.querySelector("img").alt=t.offer.title,r.dataset.adIndex=o,r.addEventListener("click",(e=>{const o="map__pin"===e.target.className?e.target:e.target.parentElement;o.dataset.adIndex&&(window.card.render(t),o.classList.add("map__pin--active"))})),r},r=()=>{const e=t.querySelectorAll(".map__pin:not(.map__pin--main)");e&&e.forEach((e=>e.remove()))};window.pins={render:e=>{r(),t.appendChild((e=>{const t=e.length<=5?e.length:5;let r=document.createDocumentFragment();for(let n=0;n<t;n++)e[n].offer&&r.appendChild(o(e[n],n));return r})(e))},remove:r}})(),(()=>{const e={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},t=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map"),r=document.querySelector(".map__filters-container"),n=()=>{a()},s=e=>{27===e.keyCode&&a()},a=()=>{const e=o.querySelector(".map__card"),t=o.querySelector(".map__pin--active");e&&e.remove(),t&&t.classList.remove("map__pin--active"),document.removeEventListener("keydown",s)};window.card={render:i=>{a(),r.insertAdjacentElement("beforebegin",(o=>{const r=t.cloneNode(!0),n=r.querySelector(".popup__title");o.offer.title?n.textContent=o.offer.title:n.remove();const s=r.querySelector(".popup__text--address");o.offer.address?s.textContent=o.offer.address:s.remove();const a=r.querySelector(".popup__text--price");o.offer.price?a.textContent=o.offer.price+"₽/ночь":a.remove();const i=r.querySelector(".popup__type");o.offer.price?i.textContent=e[o.offer.type]:i.remove();const d=r.querySelector(".popup__text--capacity");o.offer.rooms&&o.offer.guests?d.textContent=o.offer.rooms+" комнаты для "+o.offer.guests+" гостей":d.remove();const c=r.querySelector(".popup__text--time");o.offer.checkin&&o.offer.checkout?c.textContent="Заезд после "+o.offer.checkin+", выезд до "+o.offer.checkout:c.remove();const l=r.querySelector(".popup__features");o.offer.features?((e,t)=>{const o=e.offer.features,r=t.children;window.util.removeElements(r);for(let e=0;e<o.length;e++){t.insertAdjacentHTML("beforeend","<li></li>");const r=t.lastChild;r.classList.add("popup__feature","popup__feature--"+o[e]),r.textContent=o[e]}})(o,l):l.remove();const u=r.querySelector(".popup__description");o.offer.description?u.textContent=o.offer.description:u.remove();const m=r.querySelector(".popup__photos");o.offer.photos?((e,t)=>{const o=e.offer.photos,r=t.children;window.util.removeElements(r);for(let e=0;e<o.length;e++)t.insertAdjacentHTML("beforeend",'<img src="" class="popup__photo" width="45" height="40" alt="Фотография жилья">'),t.lastChild.src=o[e]})(o,m):m.remove();const p=r.querySelector(".popup__avatar");return o.author.avatar?p.src=o.author.avatar:p.remove(),r})(i)),o.querySelector(".map__card").querySelector(".popup__close").addEventListener("click",n),document.addEventListener("keydown",s)},remove:a}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),o=t.querySelectorAll("fieldset"),r=()=>{const r=e.classList.contains("map--faded"),n=t.classList.contains("ad-form--disabled");r||e.classList.add("map--faded"),n||t.classList.add("ad-form--disabled"),t.classList.add("ad-form--disabled"),window.util.toggleElementsState(o,!0),window.filter.deactivate(),window.mainPin.addListeners(),window.form.fillAddressField(),window.form.removeListeners()};r(),window.request.load(window.data.save,window.message.error),window.main={activatePage:()=>{e.classList.remove("map--faded"),t.classList.remove("ad-form--disabled"),window.util.toggleElementsState(o,!1),window.form.fillAddressField(),window.form.addListeners(),window.pins.render(window.data.get()),window.filter.activate(),window.mainPin.removeListeners()},deactivatePage:r}})()})();